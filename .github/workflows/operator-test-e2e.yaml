name: Operator E2E Tests

on:
  push:
    branches:
      - main
      - 'feat/**'
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
  merge_group:
    types: [checks_requested]
  repository_dispatch:
    types: [e2e]
  workflow_dispatch:

jobs:
  # Gate: only same-repo PRs run heavy jobs on push. Fork PRs need /allow. Trusted contexts (dispatch, merge_group) always run.
  check-prerequisites:
    runs-on: ubuntu-latest
    steps:
    - name: Check prerequisites
      run: |
        # Fork PRs: fail so heavy jobs do not run on push (no secrets). Only /allow can trigger them.
        if [[ "${{ github.event_name }}" == 'pull_request' && "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.event.pull_request.base.repo.full_name }}" ]]; then
          echo "❌ Fork PR: heavy jobs do not run on push (no secrets). Comment /allow to trigger tests."
          echo "### Fork PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests are not run automatically from forks." >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** A maintainer must comment \`/allow\` on this PR to trigger tests." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

  check-changes:
    name: Check for relevant changes
    runs-on: ubuntu-slim
    needs: [check-prerequisites]
    permissions:
      contents: read
      checks: write
    outputs:
      operator: ${{ steps.changed-files.outputs.any_changed }}
      check_run_id: ${{ steps.create-check.outputs.check_run_id }}
      check_run_id_arm64: ${{ steps.create-check.outputs.check_run_id_arm64 }}
      check_run_id_macos: ${{ steps.create-check.outputs.check_run_id_macos }}
    steps:
      - name: Set checkout ref
        id: set-ref
        run: |
          case "${{ github.event_name }}" in
            repository_dispatch) ref=$(jq -r '.client_payload.head_sha' $GITHUB_EVENT_PATH) ;;
            merge_group)        ref=$(jq -r '.merge_group.head_sha' $GITHUB_EVENT_PATH) ;;
            *)                  ref=$(jq -r '.pull_request.head.sha' $GITHUB_EVENT_PATH) ;;
          esac
          echo "ref=$ref" >> $GITHUB_OUTPUT
          echo "Trigger: ${{ github.event_name }} → checkout ref: $ref"
      - name: Create check run (comment-triggered)
        if: github.event_name == 'repository_dispatch'
        id: create-check
        uses: actions/github-script@v8
        with:
          script: |
            const head_sha = '${{ steps.set-ref.outputs.ref }}';
            const { data: e2e } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Run Operator E2E Tests (AMD64)',
              head_sha,
              status: 'in_progress'
            });
            const { data: arm64 } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Run Operator E2E Tests (ARM64)',
              head_sha,
              status: 'in_progress'
            });
            const { data: macos } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Run Operator E2E Tests (macOS)',
              head_sha,
              status: 'in_progress'
            });
            core.setOutput('check_run_id', e2e.id);
            core.setOutput('check_run_id_arm64', arm64.id);
            core.setOutput('check_run_id_macos', macos.id);
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.set-ref.outputs.ref }}
          fetch-depth: 0
      - name: Check for changes
        uses: tj-actions/changed-files@v47
        id: changed-files
        with:
          files: |
            operator/**
            dependencies/**
            test/e2e/**
            .github/workflows/operator-test-e2e.yaml

  # Lightweight jobs that create status checks when tests are skipped
  # These use the same matrix structure and job names as the test jobs to ensure
  # status checks are always created. Since the 'if' conditions are mutually exclusive,
  # only one of test-skip or test will run, so there's no conflict with duplicate status check names.
  test-skip:
    name: ${{ matrix.job_name }}
    runs-on: ubuntu-slim
    needs: [check-prerequisites, check-changes]
    if: needs.check-changes.outputs.operator != 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            kind_binary: kind-linux-amd64
            kubectl_arch: amd64
            kubectl_os: linux
            image_suffix: ""
            cluster_suffix: ""
            test_scope: "integration+e2e"
            konflux_cr: "operator/config/samples/konflux-e2e.yaml"
            job_name: "Run Operator E2E Tests (AMD64)"
          - arch: arm64
            runner: ubuntu-24.04-arm
            kind_binary: kind-linux-arm64
            kubectl_arch: arm64
            kubectl_os: linux
            image_suffix: "-arm64"
            cluster_suffix: "-arm"
            test_scope: "integration+e2e"
            konflux_cr: "operator/config/samples/konflux-e2e.yaml"
            job_name: "Run Operator E2E Tests (ARM64)"
          - arch: arm64
            runner: macos-latest
            kind_binary: kind-darwin-arm64
            kubectl_arch: arm64
            kubectl_os: darwin
            image_suffix: "-macos"
            cluster_suffix: "-macos"
            test_scope: "integration"
            konflux_cr: "operator/config/samples/konflux-e2e.yaml"
            job_name: "Run Operator E2E Tests (macOS)"
    steps:
      - name: Skip test - no operator changes
        run: |
          echo "No operator-related changes detected. Skipping tests."
          echo "This check passes when there are no operator changes to test."

  test:
    name: ${{ matrix.job_name }}
    runs-on: ${{ matrix.runner }}
    needs: [check-prerequisites, check-changes]
    if: needs.check-changes.outputs.operator == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            kind_binary: kind-linux-amd64
            kubectl_arch: amd64
            kubectl_os: linux
            image_suffix: ""
            cluster_suffix: ""
            test_scope: "integration+e2e"
            konflux_cr: "operator/config/samples/konflux-e2e.yaml"
            job_name: "Run Operator E2E Tests (AMD64)"
          - arch: arm64
            runner: ubuntu-24.04-arm
            kind_binary: kind-linux-arm64
            kubectl_arch: arm64
            kubectl_os: linux
            image_suffix: "-arm64"
            cluster_suffix: "-arm"
            test_scope: "integration+e2e"
            konflux_cr: "operator/config/samples/konflux-e2e.yaml"
            job_name: "Run Operator E2E Tests (ARM64)"
          - arch: arm64
            runner: macos-latest
            kind_binary: kind-darwin-arm64
            kubectl_arch: arm64
            kubectl_os: darwin
            image_suffix: "-macos"
            cluster_suffix: "-macos"
            test_scope: "integration"
            konflux_cr: "operator/config/samples/konflux-e2e.yaml"
            job_name: "Run Operator E2E Tests (macOS)"
    env:
      # renovate: datasource=github-releases depName=kubernetes-sigs/kind
      KIND_VERSION: "0.31.0"
      # renovate: datasource=github-releases depName=kubernetes/kubernetes
      KUBECTL_VERSION: "1.35.1"
      OPERATOR_IMAGE: example.com/konflux-operator:v0.0.1${{ matrix.image_suffix }}
      KIND_CLUSTER: konflux-operator-test-e2e${{ matrix.cluster_suffix }}
    defaults:
      run:
        working-directory: operator
    steps:
      - name: Set checkout ref
        id: set-ref
        working-directory: ${{ github.workspace }}
        run: |
          case "${{ github.event_name }}" in
            repository_dispatch) ref=$(jq -r '.client_payload.head_sha' $GITHUB_EVENT_PATH) ;;
            merge_group)        ref=$(jq -r '.merge_group.head_sha' $GITHUB_EVENT_PATH) ;;
            *)                  ref=$(jq -r '.pull_request.head.sha' $GITHUB_EVENT_PATH) ;;
          esac
          echo "ref=$ref" >> $GITHUB_OUTPUT
          echo "Trigger: ${{ github.event_name }} → checkout ref: $ref"
      - name: Free Disk Space (Ubuntu)
        if: runner.os == 'Linux'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          docker-images: false

      - name: Clone the code
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.set-ref.outputs.ref }}

      - name: Disable AppArmor
        if: runner.os == 'Linux'
        # works around a change in ubuntu 24.04 that restricts Linux namespace access
        # for unprivileged users
        run: sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Install Docker (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install docker colima
          colima start --cpu 4 --memory 8 --disk 60
          docker context use colima
          docker info
          docker version

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: operator/go.mod
          cache-dependency-path: operator/go.sum

      - name: Install kind (${{ matrix.arch }})
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v${KIND_VERSION}/${{ matrix.kind_binary }}
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install kubectl (${{ matrix.arch }})
        run: |
          curl -LO "https://dl.k8s.io/release/v${KUBECTL_VERSION}/bin/${{ matrix.kubectl_os }}/${{ matrix.kubectl_arch }}/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl

      - name: Verify kind installation
        run: kind version

      - name: Deploy Konflux using deploy-local.sh
        working-directory: ${{ github.workspace }}
        env:
          # Cluster configuration
          KIND_CLUSTER: ${{ env.KIND_CLUSTER }}
          OPERATOR_INSTALL_METHOD: "build"
          OPERATOR_IMAGE: ${{ env.OPERATOR_IMAGE }}

          KONFLUX_CR: ${{ matrix.konflux_cr }}

          # GitHub App secrets (standardized names)
          GITHUB_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
          GITHUB_APP_ID: ${{ secrets.APP_ID }}
          WEBHOOK_SECRET: ${{ secrets.APP_WEBHOOK_SECRET }}

          # Quay secrets for image-controller (required by konflux-e2e.yaml CR)
          QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}
          QUAY_ORGANIZATION: ${{ secrets.QUAY_ORG }}

          # Smee webhook forwarding for E2E tests only
          SMEE_CHANNEL: ${{ matrix.test_scope == 'integration+e2e' && secrets.SMEE_CHANNEL || '' }}
        run: ./scripts/deploy-local.sh

      - name: Show version information
        working-directory: operator
        run: |
          kubectl version
          kind version

      - name: List namespaces
        run: |
          kubectl get namespace

      - name: Deploy Test Resources
        working-directory: ${{ github.workspace }}
        env:
          SKIP_SAMPLE_COMPONENTS: "true"
        run: |
          ./deploy-test-resources.sh

      - name: Run Konflux Integration Tests
        working-directory: ${{ github.workspace }}
        run: |
          cd test/go-tests
          go test ./...

      - name: Run E2E tests
        if: matrix.test_scope == 'integration+e2e'
        working-directory: ${{ github.workspace }}
        env:
          GH_ORG: ${{ secrets.GH_ORG }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          QUAY_DOCKERCONFIGJSON: ${{ secrets.QUAY_DOCKERCONFIGJSON }}
          RELEASE_CATALOG_TA_QUAY_TOKEN: ${{ secrets.RELEASE_CATALOG_TA_QUAY_TOKEN }}
        run: |
          ./test/e2e/run-e2e.sh

      - name: Generate error logs
        if: ${{ !cancelled() }}
        working-directory: ${{ github.workspace }}
        run: |
          echo "Konflux CR:"
          kubectl get konflux konflux -o yaml || :
          ./generate-err-logs.sh

      - name: Archive logs
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: logs-${{ matrix.arch }}
          path: logs

  # Report check result to PR when triggered by /allow (so the run appears on the PR and can gate it)
  report-operator-e2e-status:
    if: always() && needs.check-changes.outputs.check_run_id != ''
    needs: [check-changes, test-skip, test]
    runs-on: ubuntu-latest
    permissions:
      checks: write
    steps:
      - name: Update check runs
        uses: actions/github-script@v8
        with:
          script: |
            const checkRunId = parseInt(process.env.CHECK_RUN_ID);
            const checkRunIdArm64 = parseInt(process.env.CHECK_RUN_ID_ARM64);
            const checkRunIdMacos = parseInt(process.env.CHECK_RUN_ID_MACOS);
            const testResult = process.env.TEST_RESULT;
            const testSkipResult = process.env.TEST_SKIP_RESULT;
            let conclusion = 'failure';
            if (testResult === 'success' || testSkipResult === 'success') conclusion = 'success';
            else if (testResult === 'cancelled' || testSkipResult === 'cancelled') conclusion = 'cancelled';
            const update = { owner: context.repo.owner, repo: context.repo.repo, status: 'completed', conclusion };
            await github.rest.checks.update({ ...update, check_run_id: checkRunId });
            await github.rest.checks.update({ ...update, check_run_id: checkRunIdArm64 });
            await github.rest.checks.update({ ...update, check_run_id: checkRunIdMacos });
        env:
          CHECK_RUN_ID: ${{ needs.check-changes.outputs.check_run_id }}
          CHECK_RUN_ID_ARM64: ${{ needs.check-changes.outputs.check_run_id_arm64 }}
          CHECK_RUN_ID_MACOS: ${{ needs.check-changes.outputs.check_run_id_macos }}
          TEST_RESULT: ${{ needs.test.result }}
          TEST_SKIP_RESULT: ${{ needs.test-skip.result }}
