# For fork PRs only: org members trigger E2E runs by commenting /allow on the PR.
# (Same-repo PRs from collaborators run CI automatically via pull_request_target.)
#
# Flow: Maintainer comments /allow → we verify the head SHA was seen by GitHub before
# the comment (TOCTOU using check suite created_at; server-side, not spoofable), then dispatch "e2e".

name: PR Comment Commands

on:
  issue_comment:
    types: [created]

jobs:
  handle-command:
    name: Handle /allow
    runs-on: ubuntu-latest
    permissions:
      contents: write   # required for repos.createDispatchEvent
      pull-requests: read
      checks: read      # list check suites for ref (when GitHub first saw this SHA)
      issues: write     # for reactions and posting error comments
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/allow') &&
      contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
    steps:
      - name: Verify Security & Get PR Details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // 1. Fetch PR to get the current HEAD SHA
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const headSha = pr.data.head.sha;
            console.log(`Checking SHA: ${headSha}`);

            // 2. When did GitHub first see this SHA? Use check suite created_at (server-side, not spoofable).
            const { data: suitesData } = await github.rest.checks.listSuitesForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: headSha,
              per_page: 100
            });

            let shaFirstSeenAt;
            if (suitesData.total_count > 0 && suitesData.check_suites.length > 0) {
              const createdDates = suitesData.check_suites.map(s => new Date(s.created_at).getTime());
              shaFirstSeenAt = new Date(Math.min(...createdDates));
            } else {
              shaFirstSeenAt = new Date();
            }

            const commentTime = new Date(context.payload.comment.created_at);
            console.log(`Comment: ${commentTime.toISOString()}, SHA first seen: ${shaFirstSeenAt.toISOString()}`);

            // 3. If SHA appeared after the comment, abort. Small buffer for server clock skew only.
            if (shaFirstSeenAt > new Date(commentTime.getTime() + 2000)) {
              const message = [
                "⚠️ **Security Halt:** The code revision is newer than your `/allow` command.",
                "",
                "To prevent testing unreviewed code, this run has been aborted.",
                "Please review the new changes and comment `/allow` again."
              ].join("\n");
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
              core.setFailed("Aborting: TOCTOU (SHA is newer than comment).");
              return;
            }

            core.setOutput('number', pr.data.number);
            core.setOutput('head_sha', headSha);

      - name: Trigger E2E workflows
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          HEAD_SHA: ${{ steps.pr.outputs.head_sha }}
          TRIGGERED_BY: ${{ github.event.comment.user.login }}
        with:
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'e2e',
              client_payload: {
                pr_number: parseInt(process.env.PR_NUMBER),
                head_sha: process.env.HEAD_SHA,
                triggered_by: process.env.TRIGGERED_BY
              }
            });
