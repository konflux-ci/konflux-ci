# Org members can trigger E2E runs on any PR by commenting /allow.
# One comment = one run of both Operator E2E and Sanity workflows.
#
# How it works:
# - Bot or org member pushes to a PR branch → workflow runs on pull_request_target.
#   check-prerequisites runs, sees PR author is bot/org member → exits 0 → rest of
#   workflow runs (check-changes, then test or test-skip). No comment needed.
# - Non-member pushes → same trigger, but check-prerequisites runs, sees PR author
#   is not bot and not org member → exits 1 → workflow fails there. No later jobs
#   run. To run CI, an org member must comment /allow → pr-comment-commands dispatches
#   "e2e" → both workflows run via repository_dispatch (they skip the PR gate).

name: PR Comment Commands

on:
  issue_comment:
    types: [created]

jobs:
  handle-command:
    name: Handle /allow
    runs-on: ubuntu-latest
    permissions:
      contents: write   # required for repos.createDispatchEvent
      pull-requests: read
      issues: write    # for reactions.createForIssueComment
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/allow') &&
      contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('number', pr.data.number);
            core.setOutput('head_sha', pr.data.head.sha);

      - name: Trigger E2E workflows
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          HEAD_SHA: ${{ steps.pr.outputs.head_sha }}
          TRIGGERED_BY: ${{ github.event.comment.user.login }}
        with:
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'e2e',
              client_payload: {
                pr_number: parseInt(process.env.PR_NUMBER),
                head_sha: process.env.HEAD_SHA,
                triggered_by: process.env.TRIGGERED_BY
              }
            });
