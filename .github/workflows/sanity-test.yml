# DEPRECATED: This workflow tests the legacy (non-operator) deployment method.
# It will be removed once all environments (e.g., Fedora cluster) migrate to
# the operator-based deployment tested by operator-test-e2e.yaml.
#
# For new deployments, use the Konflux operator via scripts/deploy-local.sh

name: Sanity Test

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, unlabeled]
  merge_group:
    types: [checks_requested]
  repository_dispatch:
    types: [e2e]

jobs:
  # Gate: bots, repo collaborators (write+), or repository_dispatch/merge_group. Others need /allow from a maintainer.
  check-prerequisites:
    runs-on: ubuntu-latest
    steps:
    - name: Check prerequisites
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_AUTHOR: ${{ github.event.pull_request.user.login }}
      run: |
        # 1. Allow Manual Dispatch or Merge Queue
        if [[ "${{ github.event_name }}" == 'repository_dispatch' || "${{ github.event_name }}" == 'merge_group' ]]; then
          echo "‚úÖ Trigger is ${{ github.event_name }} (Trusted Context). Allowed."
          exit 0
        fi

        # 2. Check Bot Whitelist
        declare -a WHITELISTED_BOTS=(
          "renovate[bot]"
          "red-hat-konflux[bot]"
          "github-actions[bot]"
          "konflux-ci-update-bot[bot]"
        )

        for BOT in "${WHITELISTED_BOTS[@]}"; do
          if [[ "$PR_AUTHOR" == "$BOT" ]]; then
            echo "‚úÖ Author is whitelisted bot ($BOT). Allowed."
            exit 0
          fi
        done

        # 3. Check Repository Permissions (works with private org membership)
        USER_PERM=$(gh api "/repos/${{ github.repository }}/collaborators/$PR_AUTHOR/permission" --jq .permission 2>/dev/null || echo "none")

        if [[ "$USER_PERM" =~ ^(admin|write|maintain)$ ]]; then
          echo "‚úÖ Author ($PR_AUTHOR) has '$USER_PERM' access. Allowed."
          exit 0
        fi

        # 4. Fail and Instruct
        echo "‚ùå Blocked: Untrusted author ($PR_AUTHOR) with permission '$USER_PERM'."

        cat <<EOF >> $GITHUB_STEP_SUMMARY
        ### üõë CI Approval Required
        The PR author is not a maintainer or whitelisted bot.
        **Action Required:** A maintainer must comment \`/allow\` on this PR to trigger tests.
        EOF

        exit 1

  sanity-test:
    needs: check-prerequisites
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    outputs:
      check_run_id: ${{ steps.create-check.outputs.check_run_id }}
    steps:
      - name: Set checkout ref
        id: set-ref
        run: |
          case "${{ github.event_name }}" in
            repository_dispatch) ref=$(jq -r '.client_payload.head_sha' $GITHUB_EVENT_PATH) ;;
            merge_group)        ref=$(jq -r '.merge_group.head_sha' $GITHUB_EVENT_PATH) ;;
            *)                  ref=$(jq -r '.pull_request.head.sha' $GITHUB_EVENT_PATH) ;;
          esac
          echo "ref=$ref" >> $GITHUB_OUTPUT
          echo "Trigger: ${{ github.event_name }} ‚Üí checkout ref: $ref"
      - name: Create check run (comment-triggered)
        if: github.event_name == 'repository_dispatch'
        id: create-check
        uses: actions/github-script@v8
        with:
          script: |
            const head_sha = '${{ steps.set-ref.outputs.ref }}';
            const { data } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Sanity Test',
              head_sha,
              status: 'in_progress'
            });
            core.setOutput('check_run_id', data.id);
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false

          docker-images: false
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.set-ref.outputs.ref }}

      - name: Disable AppArmor
        # works around a change in ubuntu 24.04 that restricts Linux namespace access
        # for unprivileged users
        run: sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1
        with:
          config: kind-config.yaml

      - name: Show version information
        run: |
          kubectl version
          kind version

      - name: List namespaces
        run: |
          kubectl get namespace

      - name: Deploying Dependencies
        run: |
          ./deploy-deps.sh

      - name: List namespaces
        run: |
          kubectl get namespace

      - name: Wait for the dependencies to be ready
        run: |
          ./wait-for-all.sh

      - name: Deploying Konflux
        run: |
          ./deploy-konflux.sh

      - name: List namespaces
        run: |
          kubectl get namespace

      - name: Deploy test resources
        env:
          SKIP_SAMPLE_COMPONENTS: "true"
        run: |
          ./deploy-test-resources.sh

      - name: Run Go Tests
        run: |
          cd test/go-tests
          go test ./...

      - name: Prepare resources for E2E tests
        env:
          APP_ID: ${{ secrets.APP_ID }}
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
          APP_WEBHOOK_SECRET: ${{ secrets.APP_WEBHOOK_SECRET }}
          QUAY_ORG: ${{ secrets.QUAY_ORG }}
          QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}
          SMEE_CHANNEL: ${{ secrets.SMEE_CHANNEL }}
        run: |
          ./test/e2e/prepare-e2e.sh

      - name: Run E2E tests
        env:
          GH_ORG: ${{ secrets.GH_ORG }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          QUAY_DOCKERCONFIGJSON: ${{ secrets.QUAY_DOCKERCONFIGJSON }}
          RELEASE_CATALOG_TA_QUAY_TOKEN: ${{ secrets.RELEASE_CATALOG_TA_QUAY_TOKEN }}
        run: |
          ./test/e2e/run-e2e.sh

      - name: Generate error logs
        if: ${{ !cancelled() }}
        run: |
          ./generate-err-logs.sh

      - name: Archive logs
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: logs
          path: logs

  # Report check result to PR when triggered by /allow (so the run appears on the PR and can gate it)
  report-sanity-status:
    if: always() && needs.sanity-test.outputs.check_run_id != ''
    needs: [sanity-test]
    runs-on: ubuntu-latest
    permissions:
      checks: write
    steps:
      - name: Update check run
        uses: actions/github-script@v8
        with:
          script: |
            const checkRunId = parseInt(process.env.CHECK_RUN_ID);
            const result = process.env.SANITY_RESULT;
            let conclusion = 'failure';
            if (result === 'success') conclusion = 'success';
            else if (result === 'cancelled') conclusion = 'cancelled';
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: checkRunId,
              status: 'completed',
              conclusion
            });
        env:
          CHECK_RUN_ID: ${{ needs.sanity-test.outputs.check_run_id }}
          SANITY_RESULT: ${{ needs.sanity-test.result }}
