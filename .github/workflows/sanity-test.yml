name: Sanity Test

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, unlabeled]
  merge_group:
    types: [checks_requested]
jobs:
  check-prerequisites:
    runs-on: ubuntu-latest
    steps:
    - name: Check prerequisites for running Sanity test
      run: |
        if [ "${{ github.event_name }}" != 'pull_request_target' ]; then
          echo "The workflow is not triggered from PR, but ${{ github.event_name }} - skipping further checks."
          exit 0
        fi

        WHITELISTED_BOT_NAMES=(
          "renovate[bot]"
          "red-hat-konflux[bot]"
          "github-actions[bot]"
          "konflux-ci-update-bot[bot]"
        )
        REQUIRED_LABEL_NAME="ok-to-test"

        ORG="${{ github.repository_owner }}"
        PR_AUTHOR=$(jq --raw-output .pull_request.user.login $GITHUB_EVENT_PATH)
        echo "PR author: $PR_AUTHOR"
        PR_LABELS=$(jq --raw-output .pull_request.labels[].name $GITHUB_EVENT_PATH)

        # Check if PR author is in the whitelisted bots list
        BOT_WHITELISTED=false
        for BOT_NAME in "${WHITELISTED_BOT_NAMES[@]}"; do
          if [ "$PR_AUTHOR" == "$BOT_NAME" ]; then
            BOT_WHITELISTED=true
            echo "PR author is $BOT_NAME, skipping further checks."
            break
          fi
        done

        if [ "$BOT_WHITELISTED" == "true" ]; then
          exit 0
        fi

        if [[ "$PR_LABELS" == *$REQUIRED_LABEL_NAME* ]]; then
          echo "PR has '$REQUIRED_LABEL_NAME' label, skipping further checks."
          exit 0
        fi

        if gh api "/orgs/$ORG/members/$PR_AUTHOR"; then
          echo "PR author is a member of $ORG GitHub organization, skipping further checks"
          exit 0
        fi

        # Create comma-separated list for error message
        BOT_LIST=$(IFS=','; echo "${WHITELISTED_BOT_NAMES[*]}")

        ERROR_SUMMARY=$(cat <<EOF

        ### âŒ Cannot run Sanity test - at least one of the following conditions must be met:
        * PR author is one of: $BOT_LIST
        * PR has label '$REQUIRED_LABEL_NAME'
        * PR author is a public member of '$ORG' GitHub organization
        EOF
        )
        echo "$ERROR_SUMMARY" >> $GITHUB_STEP_SUMMARY
        echo "$ERROR_SUMMARY"

        exit 1
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  sanity-test:
    needs: check-prerequisites
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false

          docker-images: false
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: "${{ github.event.pull_request.head.sha }}"

      - name: Disable AppArmor
        # works around a change in ubuntu 24.04 that restricts Linux namespace access
        # for unprivileged users
        run: sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1
        with:
          config: kind-config.yaml

      - name: Show version information
        run: |
          kubectl version
          kind version

      - name: List namespaces
        run: |
          kubectl get namespace

      - name: Deploying Dependencies
        run: |
          ./scripts/deploy-deps.sh

      - name: List namespaces
        run: |
          kubectl get namespace

      - name: Wait for the dependencies to be ready
        run: |
          ./scripts/wait-for-all.sh

      - name: Deploying Konflux
        run: |
          ./scripts/deploy-konflux.sh

      - name: List namespaces
        run: |
          kubectl get namespace

      - name: Deploy test resources
        run: |
          ./scripts/deploy-test-resources.sh

      - name: Run Go Tests
        run: |
          cd test/go-tests
          go test ./...

      - name: Prepare resources for E2E tests
        env:
          APP_ID: ${{ secrets.APP_ID }}
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
          APP_WEBHOOK_SECRET: ${{ secrets.APP_WEBHOOK_SECRET }}
          QUAY_ORG: ${{ secrets.QUAY_ORG }}
          QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}
          SMEE_CHANNEL: ${{ secrets.SMEE_CHANNEL }}
        run: |
          ./test/e2e/prepare-e2e.sh

      - name: Run E2E tests
        env:
          GH_ORG: ${{ secrets.GH_ORG }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          QUAY_DOCKERCONFIGJSON: ${{ secrets.QUAY_DOCKERCONFIGJSON }}
          RELEASE_SERVICE_CATALOG_REVISION: ${{ secrets.RELEASE_SERVICE_CATALOG_REVISION }}
        run: |
          ./test/e2e/run-e2e.sh

      - name: Generate error logs
        if: ${{ !cancelled() }}
        run: |
          ./scripts/generate-err-logs.sh

      - name: Archive logs
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: logs
          path: logs
