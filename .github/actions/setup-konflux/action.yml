name: 'Setup Konflux'
description: 'Deploy Konflux on a Kind cluster for testing and development'
inputs:
  github_app_id:
    description: 'GitHub App ID for Konflux integration'
    required: true
  webhook_secret:
    description: 'Webhook verification secret'
    required: true
  github_private_key:
    description: 'GitHub App Private Key'
    required: true
  quay_token:
    description: 'Quay.io robot token (e.g. key:token) for image-controller'
    required: false
  quay_organization:
    description: 'Quay.io organization for image-controller'
    required: false
  konflux_cr_path:
    description: 'Path to custom Konflux CR file (relative to GITHUB_WORKSPACE or absolute)'
    required: false
  install_method:
    description: 'Installation method: release, build, or local'
    required: false
    default: 'release'
runs:
  using: "composite"
  steps:
    - name: Ensure Kind is installed
      shell: bash
      run: |
        if ! command -v kind &> /dev/null; then
          echo "Installing Kind..."
          # Install using official reliable method or tool cache if available?
          # Simple binary download for linux-amd64
          curl -Lo ./kind "https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64"
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
        fi

    - name: Deploy Konflux
      shell: bash
      env:
        GITHUB_APP_ID: ${{ inputs.github_app_id }}
        WEBHOOK_SECRET: ${{ inputs.webhook_secret }}
        GITHUB_PRIVATE_KEY: ${{ inputs.github_private_key }}
        QUAY_TOKEN: ${{ inputs.quay_token }}
        QUAY_ORGANIZATION: ${{ inputs.quay_organization }}
        OPERATOR_INSTALL_METHOD: ${{ inputs.install_method }}
        KONFLUX_CR: ${{ inputs.konflux_cr_path }}
      run: |
        # The script is located relative to this action.yml file within the action repository
        SCRIPT_PATH="${{ github.action_path }}/../../../scripts/deploy-local.sh"
        
        if [ ! -f "$SCRIPT_PATH" ]; then
          echo "Error: deploy-local.sh not found at expected path: $SCRIPT_PATH"
          exit 1
        fi
        
        # Execute deploy-local.sh
        # Note: deploy-local.sh determines its repo root based on its location, 
        # so it will use the artifacts bundled with this action version.
        "$SCRIPT_PATH" "${{ inputs.konflux_cr_path }}"
