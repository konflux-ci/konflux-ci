apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
# renovate: datasource=git-refs depName=https://github.com/kyverno/kyverno versioning=semver
- https://github.com/kyverno/kyverno/releases/download/v1.17.1/install.yaml
- kyverno-rbac.yaml

patches:
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment
    name: kyverno-background-controller
    namespace: kyverno
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 0
  target:
    kind: Deployment
    name: kyverno-cleanup-controller
    namespace: kyverno
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 0
  target:
    kind: Deployment
    name: kyverno-reports-controller
    namespace: kyverno
# Reduce kyverno-admission-controller resources to absolute minimum
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 1m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 1Mi
  target:
    kind: Deployment
    name: kyverno-admission-controller
    namespace: kyverno
# Reduce kyverno-background-controller resources to absolute minimum
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 1m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 1Mi
  target:
    kind: Deployment
    name: kyverno-background-controller
    namespace: kyverno
- patch: |-
    - op: add
      path: /spec/jobTemplate/spec/template/spec/containers/0/resources
      value:
        limits:
          cpu: 100m
          memory: 384Mi
        requests:
          cpu: 10m
          memory: 10Mi
  target:
    kind: CronJob
    namespace: kyverno
