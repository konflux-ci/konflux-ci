# Build the manager binary
FROM registry.access.redhat.com/ubi10/go-toolset@sha256:fcfd7c6a935f305a5486664cad59cf49d2dcfd98b79ee65fb55f0d7f1e4cfcd0 AS builder
ARG TARGETOS
ARG TARGETARCH
ARG OPERATOR_VERSION
ARG GIT_COMMIT

ENV GOTOOLCHAIN=auto
WORKDIR /workspace

COPY --chmod=644 go.mod go.mod
COPY --chmod=644 go.sum go.sum

RUN go mod download

COPY --chmod=644 cmd/main.go cmd/main.go
COPY --chmod=755 api/ api/
COPY --chmod=755 internal/ internal/
COPY --chmod=755 pkg/ pkg/

# Build with version info embedded via ldflags
# ARG values are expected to be passed from the build pipeline, defaulting to "unknown" if not set
RUN CGO_ENABLED=0 GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH} \
    go build -a \
    -ldflags "-X github.com/konflux-ci/konflux-ci/operator/pkg/version.Version=${OPERATOR_VERSION:-unknown} \
              -X github.com/konflux-ci/konflux-ci/operator/pkg/version.GitCommit=${GIT_COMMIT:-unknown}" \
    -o /opt/app-root/manager cmd/main.go

# Use UBI minimal as base image
FROM registry.access.redhat.com/ubi10/ubi-minimal@sha256:380da76bb8a69e333b6c11341d600f5d3aab9ee5b8c95ceb64aae2457f5c1c6e
ARG OPERATOR_VERSION
WORKDIR /

COPY --from=builder /opt/app-root/manager .
COPY LICENSE /licenses/
USER 65532:65532

LABEL name="Konflux Operator"
LABEL description="Kubernetes operator for managing Konflux installations"
LABEL summary="Kubernetes operator for managing Konflux installations"
LABEL io.k8s.description="Kubernetes operator for managing Konflux installations"
LABEL io.k8s.display-name="konflux-operator"
LABEL version="${OPERATOR_VERSION#v}"
LABEL release="1"
LABEL vendor="Red Hat, Inc."
# vendor label should be solved in conforma
LABEL distribution-scope="public"
LABEL url="https://github.com/konflux-ci/konflux-ci/operator"
LABEL maintainer="Konflux CI"
LABEL com.redhat.component="konflux-operator"
# com.redhat.component label should be solved in conforma

ENTRYPOINT ["/manager"]
