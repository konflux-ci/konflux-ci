# Build the manager binary
FROM registry.access.redhat.com/ubi10/go-toolset@sha256:1edf7bd8e7175ec53a5eefb4e0008adfe30cb7b5ad6834ed7eeef1df9f1920dd AS builder
ARG TARGETOS
ARG TARGETARCH
ARG OPERATOR_VERSION
ARG GIT_COMMIT

ENV GOTOOLCHAIN=auto
WORKDIR /workspace

COPY --chmod=644 go.mod go.mod
COPY --chmod=644 go.sum go.sum

RUN go mod download

COPY --chmod=644 cmd/main.go cmd/main.go
COPY --chmod=755 api/ api/
COPY --chmod=755 internal/ internal/
COPY --chmod=755 pkg/ pkg/

# Build with version info embedded via ldflags
# ARG values are expected to be passed from the build pipeline, defaulting to "unknown" if not set
RUN CGO_ENABLED=0 GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH} \
    go build -a \
    -ldflags "-X github.com/konflux-ci/konflux-ci/operator/pkg/version.Version=${OPERATOR_VERSION:-unknown} \
              -X github.com/konflux-ci/konflux-ci/operator/pkg/version.GitCommit=${GIT_COMMIT:-unknown}" \
    -o /opt/app-root/manager cmd/main.go

# Use UBI minimal as base image
FROM registry.access.redhat.com/ubi10/ubi-minimal@sha256:a74a7a92d3069bfac09c6882087771fc7db59fa9d8e16f14f4e012fe7288554c
ARG OPERATOR_VERSION
WORKDIR /

COPY --from=builder /opt/app-root/manager .
COPY LICENSE /licenses/
USER 65532:65532

LABEL name="Konflux Operator"
LABEL description="Kubernetes operator for managing Konflux installations"
LABEL summary="Kubernetes operator for managing Konflux installations"
LABEL io.k8s.description="Kubernetes operator for managing Konflux installations"
LABEL io.k8s.display-name="konflux-operator"
LABEL version="${OPERATOR_VERSION#v}"
LABEL release="1"
LABEL vendor="Red Hat, Inc."
# vendor label should be solved in conforma
LABEL distribution-scope="public"
LABEL url="https://github.com/konflux-ci/konflux-ci/operator"
LABEL maintainer="Konflux CI"
LABEL com.redhat.component="konflux-operator"
# com.redhat.component label should be solved in conforma

ENTRYPOINT ["/manager"]
