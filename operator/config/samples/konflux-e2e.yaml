# Title: Konflux E2E Test Configuration
# Description: Konflux configuration for E2E tests with image-controller enabled
#
# This sample extends the base configuration with image-controller enabled,
# which is required for E2E tests but optional for local development.
#
# Usage:
#   E2E CI: Used by .github/workflows/operator-test-e2e.yaml
#   Local E2E testing: KONFLUX_CR=operator/config/samples/konflux-e2e.yaml ./scripts/deploy-local.sh
apiVersion: konflux.konflux-ci.dev/v1alpha1
kind: Konflux
metadata:
  labels:
    app.kubernetes.io/name: konflux-operator
    app.kubernetes.io/managed-by: kustomize
  name: konflux
spec:
  ui:
    spec:
      ingress:
        nodePortService:
          httpsPort: 30011
      proxy:
        replicas: 1
        nginx:
          resources:
            requests:
              cpu: 30m
              memory: 128Mi
            limits:
              cpu: 30m
              memory: 128Mi
      dex:
        config:
          enablePasswordDB: true
          passwordConnector: local
          # WARNING: Demo users for CI and local development ONLY
          # For production, remove staticPasswords and configure OIDC connectors
          # See docs/operator-deployment.md for production authentication examples
          staticPasswords:
          - email: "user1@konflux.dev"
            # bcrypt hash of the string "password": $(echo password | htpasswd -BinC 10 admin | cut -d: -f2)
            hash: "$2a$10$2b2cU8CPhOTaGrs1HRQuAueS7JTT5ZHsHSzYiFPm1leZck7Mc8T4W" # notsecret
            username: "user1"
            userID: "7138d2fe-724e-4e86-af8a-db7c4b080e20"
          - email: "user2@konflux.dev"
            # bcrypt hash of the string "password": $(echo password | htpasswd -BinC 10 admin | cut -d: -f2)
            hash: "$2a$10$2b2cU8CPhOTaGrs1HRQuAueS7JTT5ZHsHSzYiFPm1leZck7Mc8T4W" # notsecret
            username: "user2"
            userID: "ea8e8ee1-2283-4e03-83d4-b00f8b821b64"
  integrationService:
    spec:
      integrationControllerManager:
        replicas: 1
        manager:
          resources:
            requests:
              cpu: 30m
              memory: 128Mi
            limits:
              cpu: 30m
              memory: 128Mi
  releaseService:
    spec:
      releaseControllerManager:
        replicas: 1
        manager:
          resources:
            requests:
              cpu: 30m
              memory: 128Mi
            limits:
              cpu: 30m
              memory: 128Mi
  buildService:
    spec:
      buildControllerManager:
        replicas: 1
        manager:
          resources:
            requests:
              cpu: 30m
              memory: 128Mi
            limits:
              cpu: 30m
              memory: 128Mi
  namespaceLister:
    spec:
      namespaceLister:
        replicas: 1
        namespaceLister:
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
  info:
    spec:
      publicInfo:
        environment: development
        visibility: public
      banner:
        items:
          # Display a banner at the top of the Konflux UI to all users.
          - summary: "Welcome to Konflux-CI! This development and testing environment has been deployed with default insecure passwords!"
            type: danger
  certManager:
    # CreateClusterIssuer controls whether cluster issuer resources are created
    # Defaults to true if not specified
    createClusterIssuer: true
  internalRegistry:
    # Enabled controls whether internal registry resources are deployed
    # Defaults to false if not specified
    # For local development on Kind, this provides an OCI registry at localhost:5001
    enabled: true
  # Default tenant creates a shared namespace accessible by all authenticated users.
  # Needed for E2E tests. See konflux_v1alpha1_konflux.yaml for detailed documentation.
  defaultTenant:
    enabled: true
  # E2E-specific: Enable image-controller for E2E tests
  imageController:
    enabled: true
