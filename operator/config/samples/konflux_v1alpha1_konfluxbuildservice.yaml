# Title: Konflux Build Service Configuration
# Description: KonfluxBuildService configuration with custom resource limits and environment variables
apiVersion: konflux.konflux-ci.dev/v1alpha1
kind: KonfluxBuildService
metadata:
  labels:
    app.kubernetes.io/name: konflux-operator
    app.kubernetes.io/managed-by: kustomize
  name: konflux-build-service
spec:
  buildControllerManager:
    replicas: 2
    manager:
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
      env:
        - name: PAC_WEBHOOK_URL
          value: "http://pipelines-as-code-controller.pipelines-as-code.svc.cluster.local:8180"
        - name: EXAMPLE_CUSTOM_CONFIG
          valueFrom:
            configMapKeyRef:
              name: build-service-config
              key: custom-config
        - name: EXAMPLE_SECRET_VALUE
          valueFrom:
            secretKeyRef:
              name: build-service-secret
              key: secret-key

  # Pipeline Configuration Management
  # managePipelineConfig: true   # Default: operator manages build-pipeline-config ConfigMap
  # managePipelineConfig: false  # Advanced: user manages custom pipeline bundles
  #
  # Use managePipelineConfig: false when you need custom pipeline bundles
  # (e.g., for slsa-konflux-example or other specialized pipelines).
  #
  # Workflow to transition from operator-managed to self-managed:
  # 1. Update this CR: set managePipelineConfig: false
  # 2. Wait for reconciliation, then delete the existing ConfigMap:
  #    kubectl delete configmap build-pipeline-config -n build-service
  # 3. Create your custom ConfigMap with your pipeline definitions:
  #    kubectl apply -f my-custom-pipeline-config.yaml
  #
  # Example custom ConfigMap structure:
  # ---
  # apiVersion: v1
  # kind: ConfigMap
  # metadata:
  #   name: build-pipeline-config
  #   namespace: build-service
  # data:
  #   config.yaml: |
  #     default-pipeline-name: my-custom-pipeline
  #     pipelines:
  #     - name: my-custom-pipeline
  #       bundle: quay.io/my-org/my-pipeline@sha256:abc123...
